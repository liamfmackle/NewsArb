generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  displayName   String?
  googleId      String?   @unique
  role          UserRole  @default(user)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Kudos system (reputation points)
  totalKudos    Int       @default(0)
  weeklyKudos   Int       @default(0)
  allTimeRank   Int?
  weeklyRank    Int?

  stories       Story[]
  submissions   Submission[]
  kudosHistory  KudosHistory[]

  @@index([email])
  @@index([totalKudos])
  @@index([weeklyKudos])
}

enum UserRole {
  user
  admin
}

model Story {
  id               String      @id @default(cuid())
  title            String
  url              String?
  description      String
  sourceDomain     String
  submitterId      String
  canonicalEventId String?
  status           StoryStatus @default(pending)
  aiClassification String?
  safetyFlags      String?     // JSON string for SQLite compatibility
  embedding        String?     // JSON string of float array for SQLite compatibility

  // Entity extraction (JSON strings for matching)
  entitiesPeople       String? // JSON array of person names
  entitiesOrgs         String? // JSON array of organization names
  entitiesLocations    String? // JSON array of location names
  entitiesEvents       String? // JSON array of specific event names
  entitiesTopics       String? // JSON array of topic/theme names
  entitiesExtractedAt  DateTime? // When entities were extracted

  // Match metadata
  matchedToMarketId    String?   // If this submission was matched to existing market
  matchConfidence      Float?    // Confidence score of the match
  matchDecision        String?   // "exact_match", "likely_match", "user_confirmed", "create_new"

  // Virality tracking
  currentViralityScore Float?
  peakViralityScore    Float?
  viralityTrend        ViralityTrend?

  // Kudos tracking
  kudosPool            Int       @default(0)  // Total kudos distributed for this story
  kudosDistributed     Boolean   @default(false)  // Whether kudos have been awarded

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submitter         User               @relation(fields: [submitterId], references: [id])
  canonicalEvent    CanonicalEvent?    @relation(fields: [canonicalEventId], references: [id])
  viralitySnapshots ViralitySnapshot[]
  submissions       Submission[]
  kudosHistory      KudosHistory[]

  @@index([status])
  @@index([createdAt])
  @@index([submitterId])
  @@index([canonicalEventId])
  @@index([matchedToMarketId])
  @@index([kudosDistributed])
}

enum ViralityTrend {
  rising
  stable
  declining
}

model CanonicalEvent {
  id          String   @id @default(cuid())
  title       String   // Representative title for the event
  description String?  // Summary of the event
  embedding   String?  // Primary embedding for similarity matching

  // Aggregated entities from all linked stories
  entitiesPeople    String? // JSON array - union of all story entities
  entitiesOrgs      String? // JSON array - union of all story entities
  entitiesLocations String? // JSON array - union of all story entities
  entitiesEvents    String? // JSON array - union of all story entities
  entitiesTopics    String? // JSON array - union of all story entities

  // Event metadata
  category        String?   // Primary category of the event
  sourceDomains   String?   // JSON array of all source domains
  storyCount      Int       @default(1) // Number of linked stories

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stories Story[] // All stories linked to this event

  @@index([createdAt])
  @@index([category])
}

enum StoryStatus {
  pending
  active
  settled    // Renamed from 'capped' - kudos have been distributed
  rejected
}

model ViralitySnapshot {
  id      String @id @default(cuid())
  storyId String
  story   Story  @relation(fields: [storyId], references: [id])

  // Raw metrics
  articleCount   Int   // Cross-platform article mentions
  socialMentions Int   // Twitter/Reddit/etc mentions
  searchInterest Int   // Google Trends 0-100
  engagementRate Float // Composite engagement

  // Computed
  viralityScore  Float         // Weighted composite 0-100
  velocityChange Float         // Score change rate (positive = rising)
  trend          ViralityTrend // rising | stable | declining

  timestamp DateTime @default(now())

  @@index([storyId, timestamp])
  @@index([timestamp])
}

// Submission - tracks who discovered/submitted stories and when
model Submission {
  id          String   @id @default(cuid())
  userId      String
  storyId     String
  submittedAt DateTime @default(now())
  kudosEarned Int      @default(0)
  isOriginal  Boolean  @default(false)  // First submitter of this story

  user  User  @relation(fields: [userId], references: [id])
  story Story @relation(fields: [storyId], references: [id])

  @@unique([userId, storyId])
  @@index([userId])
  @@index([storyId])
  @@index([submittedAt])
}

// KudosHistory - tracks all kudos earnings and reasons
model KudosHistory {
  id        String      @id @default(cuid())
  userId    String
  amount    Int
  reason    KudosReason
  storyId   String?
  createdAt DateTime    @default(now())

  user  User   @relation(fields: [userId], references: [id])
  story Story? @relation(fields: [storyId], references: [id])

  @@index([userId])
  @@index([storyId])
  @@index([createdAt])
  @@index([reason])
}

enum KudosReason {
  early_discovery    // Submitted/discovered story early
  viral_bonus        // Story achieved high virality
  first_discoverer   // Original discoverer of story
  weekly_reset       // Weekly kudos reset (negative entry)
}
